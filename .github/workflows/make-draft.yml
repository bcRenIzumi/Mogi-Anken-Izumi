name: ドラフト作成
on:
    workflow_dispatch:
        inputs:
            head_branch:
                description: "作成するPRのソースブランチ"
                required: true
                default: "feature/draft"
            base_branch:
                description: "PRのターゲットブランチ"
                required: true
                default: "main"
            draft_title:
                description: "PRのタイトル（空の場合はAI生成）"
                required: false
jobs:
    make-draft:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: Install Cursor CLI
              run: |
                  curl https://cursor.com/install -fsS | bash
                  echo "$HOME/.cursor/bin" >> $GITHUB_PATH
            - name: Install GitHub CLI
              run: |
                  curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
                  echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
                  sudo apt update
                  sudo apt install gh

            - name: AI Draft generation with Cursor Agent
              env:
                  CURSOR_API_KEY: ${{secrets.CURSOR_API_KEY || 'key_86b7926da5f5334585fd9853ebf3154e6d59dbed187de0b5208cd40152929c88'}}
                  MODEL: ${{ vars.CURSOR_MODEL || 'gpt-5' }}
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  cursor-agent --force --api-key "$CURSOR_API_KEY" --output-format=text --print "なんでもいいのでドラフトを作成してください" > draft_content.txt

            - name: Create Draft Pull Request
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  HEAD_BRANCH: ${{ inputs.head_branch }}
                  BASE_BRANCH: ${{ inputs.base_branch }}
                  DRAFT_TITLE: ${{ inputs.draft_title }}
              run: |
                  # タイトルが指定されている場合はそれを使用、なければAI生成内容から取得
                  if [ -n "$DRAFT_TITLE" ]; then
                    TITLE="$DRAFT_TITLE"
                    BODY=$(cat draft_content.txt)
                  else
                    # タイトルと本文を分離（最初の行をタイトル、それ以降を本文とする）
                    TITLE=$(head -n 1 draft_content.txt)
                    BODY=$(tail -n +2 draft_content.txt)

                    # タイトルが空の場合はデフォルトタイトルを使用
                    if [ -z "$TITLE" ]; then
                      TITLE="AI Generated Draft PR - $(date +%Y%m%d_%H%M%S)"
                    fi
                  fi

                  # 現在のブランチがHEAD_BRANCHと一致するか確認
                  CURRENT_BRANCH=$(git branch --show-current)
                  if [ "$CURRENT_BRANCH" != "$HEAD_BRANCH" ]; then
                    echo "Error: Current branch ($CURRENT_BRANCH) does not match specified head branch ($HEAD_BRANCH)"
                    echo "Please run this workflow from the correct branch or specify the correct head_branch parameter."
                    exit 1
                  fi

                  # ドラフトPRを作成
                  gh pr create \
                    --title "$TITLE" \
                    --body "$BODY" \
                    --draft \
                    --base $BASE_BRANCH \
                    --head $HEAD_BRANCH
